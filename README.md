# Forward Elements Challenge

### Notice!!!

The code should run with no issues without any changes. If you can't get it running, please let us know immediately so we can help you resolve local issues.

## Example
<a href="./demo.webm" target="_blank">Video Demo</a>

### What We Use

An understanding of the following technologies is helpful, but not required.

- Next.js
- Tailwind CSS
- Shadcn/UI - https://ui.shadcn.com/ - A library of pre-built components
- NX - https://nx.dev/ - Monorepo build system with built in support for React, Next.js, and Typescript
- TS Rest - https://ts-rest.com/ - Two-Way Typesafe APIs

### Repository Description

This is a NX mono repo containing several parts. There are 2 Nextjs applications, one represents an application that would be built by our customers called Storefront.
The other application Elements provides embeddable widgets(pages) and processing capabilities(API) similar to what we do at Forward.

To Run the applications (use node version 20)

```
npm install
npm run dev
```

Storefront is found at http://localhost:3002

The elements runs at http://localhost:3000

Part of being compliant with PCI is to isolate the collection of sensitive data as much as possible. A common technique is to create an iframe that collects the data securely, tokenizes the data into something that is not sensitive but represents the sensitive data, and passes this token to the parent window. The token is then used to process payments.

Communicating/interfacing with iframes is done using the messaging async pub/sub protocol provided by browsers. We have taken care of this complexity already. The code for this can be found in the elements-js as well as the Elements code. The elements-js and elements-react represent something that we would provide to our software customers, it makes it easy to work with our embeddable components.

When you launch the applications, you will see examples of how message passing works between the elements and the storefront.

We have also created a fake processing API as part of the Elements app to represent a backend.

#### Components

- elements-js (@fwd/elements-js) - a library that makes it easy to work with our embeddable components. It's used in the elements-react library.
- elements-react (@fwd/elements-react) - a library that makes it easy to work with our embeddable components in a React application. It's used in the storefront application.
- elements-types (@fwd/elements-types) - a library that contains the types for the system, some are shared types used by elements and the storefront.
- ui (@fwd/ui) - a library of reusable UI components from Shadcn/UI.
- storefront - a Nextjs application that is built by our customers and uses the elements-react library to embeddable components generated by the elements app.
- elements - a Nextjs application that provides embeddable widgets and processing capabilities.

### Challenge

Create an end to end process to collect card data, tokenize it and process a payment. This will require at a minimum the following:

- Update the elements app to provide a card form that is used to collect card data, tokenize the data, and return it to the parent Storefront application.
- Update the Storefront application to obtain a session token from the backend, collect the tokenized data from the embedded element, and process a payment.
  Features:
- The card form should be able to be styled dynamically from the calling application to make its style. Note: just demonstrate how this could work, no need to provide endless style options.
- No card data should be seen by the Storefront application
- Handle scenarios such as mounting multiple elements on the same page
- Handle resizing of the parent window

#### How do you know you are complete?

When you can visit the storefront application, add some items to the cart, go to the checkout page add a credit card to a form and have it process a payment. Ideally after clicking submit the payment created response from the API is displayed on the page or a new order completed page.

### Processing API Endpoints

We will provide the API Key for the Storefront application to make requests to this API. Consider this API key very sensitive.
The API contract in contract.ts in the elements-types library.

The api key is `test123`, you send it in the header `Authorization: Bearer test`

- POST /elements/payment-session - this returns a session token that is needed to authenticate requests to create token. This API requires an API key to authenticate. This session token can be considered not sensitive.
- POST /elements/payment - this endpoint will process a fake payment using a card token. The API requires an API key to authenticate.

Flow of a processed payment:

- Get a session url from the elements api.
- Get a token from the element.
- Use the token to complete a payment using the token and the create payment API.

### API Key Security Implementation

To address the security concerns with the API key, we've implemented a server-side approach that keeps the API key secure:

1. **Server-Side API Service**: All API calls that require the API key are now handled through server-side functions using Next.js's server components. The API key is stored as an environment variable that is only accessible on the server.

2. **Environment Variables**: The API key is stored in `.env.local` which is not committed to the repository, with the format provided in `.env.example`.

3. **Client-Side Refactoring**: We removed all API key references from client-side code. The API clients on the client-side no longer include authentication headers and can only be used for non-sensitive operations.

This implementation follows security best practices by:
- Keeping sensitive credentials server-side only
- Using environment variables for configuration
- Creating a clear separation between authenticated and non-authenticated operations
